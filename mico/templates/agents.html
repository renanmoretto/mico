{% extends "base.html" %}

{% block title %}mico :: agents{% endblock %}

{% block head_css %}
.agents-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, 280px);
  gap: 10px;
}

.agent-card {
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 20px 22px;
  cursor: pointer;
  transition: background 0.12s;
  display: flex;
  flex-direction: column;
  gap: 14px;
  animation: card-in 0.3s ease both;
  text-decoration: none;
  color: inherit;
}
.agent-card:hover { background: var(--accent-ghost); }
.agent-card:nth-child(2) { animation-delay: 0.06s; }
.agent-card:nth-child(3) { animation-delay: 0.12s; }
.agent-card:nth-child(4) { animation-delay: 0.18s; }
.agent-card:nth-child(5) { animation-delay: 0.24s; }
.agent-card:nth-child(6) { animation-delay: 0.30s; }

.card-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}

.card-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
}

.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-top: 12px;
  border-top: 1px solid var(--border-dim);
}

.card-channels { display: flex; flex-wrap: wrap; gap: 4px; }

.card-id {
  font-size: 9px;
  color: var(--border);
  opacity: 0.8;
  margin-top: 2px;
}

.empty-state {
  padding: 60px 32px;
  text-align: center;
  background: var(--surface);
  border: 1px solid var(--border);
}
.empty-state p { font-size: 13px; color: var(--ink-3); margin-bottom: 24px; }

@keyframes card-in { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }
{% endblock %}

{% block head %}
<script>
  function openModal() {
    document.getElementById('m').classList.add('open');
    setTimeout(function() {
      var inp = document.querySelector('#m input[name="name"]');
      if (inp) inp.focus();
    }, 50);
  }
  function closeModal() {
    document.getElementById('m').classList.remove('open');
  }
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
  });
</script>
{% endblock %}

{% block content %}

<div class="sec-head">
  <div class="sec-title">agents</div>
  <button class="btn" onclick="openModal()">+ new agent</button>
</div>

{% if rows %}
<div class="agents-grid">
  {% for row in rows %}
  <a class="agent-card" href="/agents/{{ row.id }}">
    <div class="card-top">
      <div>
        <div class="card-name">{{ row.name }}</div>
        <div class="card-id">{{ row.id[:8] }}â€¦</div>
      </div>
      {% if row.status == 'active' %}
        <span class="s-on">active</span>
      {% elif row.status == 'idle' %}
        <span class="s-idle">idle</span>
      {% else %}
        <span class="s-off">offline</span>
      {% endif %}
    </div>

    <div class="card-footer">
      <div class="card-channels">
        {% for ch in channels_by_agent[row.id][:3] %}
          <span class="tag">{{ ch.channel }}</span>
        {% endfor %}
        {% if channels_by_agent[row.id] | length > 3 %}
          <span class="tag">+{{ channels_by_agent[row.id] | length - 3 }}</span>
        {% endif %}
        {% if not channels_by_agent[row.id] %}
          <span style="color:var(--border);font-size:10px">no channels</span>
        {% endif %}
      </div>
    </div>
  </a>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <p>no agents yet</p>
  <button class="btn" onclick="openModal()">+ new agent</button>
</div>
{% endif %}

<div class="modal-bg" id="m" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-head">new agent</div>
      <form method="post" action="/agents">
        <div class="f">
          <label>Name</label>
          <input type="text" name="name" placeholder="research-assistant" autofocus required autocomplete="off" />
        </div>
        <div class="modal-acts">
          <button type="button" class="btn-no" onclick="closeModal()">cancel</button>
          <button type="submit" class="btn-do" style="flex:1">create</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
