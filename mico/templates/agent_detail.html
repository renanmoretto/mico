{% extends "base.html" %}

{% block title %}mico :: {{ agent.name }}{% endblock %}

{% block head_css %}
html, body { height: 100%; min-height: 0; overflow: hidden; }
body { display: flex; flex-direction: column; }
body > main {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  padding: 0;
  max-width: none;
  width: 100%;
}

.agent-page {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 16px 32px;
}

.agent-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
  flex-shrink: 0;
}

.agent-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.agent-title h1 {
  font-size: 15px;
  font-weight: 600;
  color: var(--ink);
}

/* ── TABS ── */
.tabs-bar {
  display: flex;
  align-items: flex-end;
  border-bottom: 1px dashed var(--border);
  margin-bottom: 16px;
  flex-shrink: 0;
}

.tab-btn {
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink-3);
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: -1px;
}
.tab-btn:hover { color: var(--ink); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

.tab-content { display: none; flex: 1; overflow: hidden; }
.tab-content.active { display: flex; flex-direction: column; }

/* ── CARDS ── */
.card-grid { display: grid; gap: 14px; }
.card-grid-2 { grid-template-columns: 2fr 1fr; }
.card-grid-equal { grid-template-columns: 1fr 1fr; }

.ch-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg);
  border: 1px solid var(--border-dim);
  margin-bottom: 6px;
}
.ch-item:last-child { margin-bottom: 0; }
.ch-name { font-size: 13px; color: var(--ink); }
.ch-status-on { font-size: 11px; color: var(--accent); }
.ch-status-off { font-size: 11px; color: var(--border); }

/* ── CHAT ── */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--surface);
  border: 1px solid var(--border);
  overflow: hidden;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  scroll-behavior: smooth;
}

.chat-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--border);
  font-size: 13px;
  gap: 6px;
}

.chat-bubble {
  max-width: 85%;
  width: fit-content;
  padding: 10px 14px;
  border: 1px solid var(--border-dim);
  margin-bottom: 10px;
  animation: bubbleIn 0.2s ease-out;
}
@keyframes bubbleIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

.chat-bubble.user {
  background: var(--sysbar);
  border-left: 3px solid var(--accent);
  margin-left: auto;
}
.chat-bubble.assistant {
  background: var(--surface);
  border-left: 3px solid var(--border);
}
.chat-bubble.system {
  background: var(--bg);
  border: 1px dashed var(--border);
  margin: 0 auto;
  text-align: center;
  font-size: 10px;
  max-width: 60%;
}

.chat-bubble .role-label {
  font-size: 10px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--ink-3);
}
.chat-bubble.user .role-label { color: var(--accent); }

.chat-bubble .content {
  color: var(--ink);
  font-size: 14px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-word;
}

.chat-bubble .timestamp {
  font-size: 9px;
  color: var(--border);
  margin-top: 4px;
  text-align: right;
}

.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border-dim);
  border-left: 3px solid var(--border);
  max-width: 60px;
  margin-bottom: 10px;
}
.typing-indicator .dot {
  width: 5px; height: 5px;
  background: var(--border);
  border-radius: 50%;
  animation: typingPulse 1.2s ease-in-out infinite;
}
.typing-indicator .dot:nth-child(2) { animation-delay: 0.15s; }
.typing-indicator .dot:nth-child(3) { animation-delay: 0.3s; }
@keyframes typingPulse {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-3px); opacity: 1; }
}

.chat-input-area {
  padding: 12px 16px;
  background: var(--sysbar);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.chat-input-row { display: flex; gap: 8px; align-items: center; }

.chat-input-row input {
  flex: 1;
  width: auto;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--ink);
  font-family: 'Geist Mono', monospace;
  font-size: 12px;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.15s;
}
.chat-input-row input:focus { border-color: var(--accent); }
.chat-input-row input:disabled { opacity: 0.5; cursor: not-allowed; }
.chat-input-row input::placeholder { color: var(--border); }

.chat-send-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px; height: 40px;
  background: var(--accent);
  border: none;
  color: #fff;
  cursor: pointer;
  transition: background 0.15s;
  flex-shrink: 0;
}
.chat-send-btn:hover:not(:disabled) { background: var(--ink); }
.chat-send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.spinner {
  width: 14px; height: 14px;
  border: 2px solid transparent;
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.hidden { display: none !important; }

.chat-status {
  font-size: 11px;
  color: var(--ink-3);
  margin-top: 6px;
  text-align: center;
  min-height: 12px;
}
.chat-status.error { color: #c0392b; }

/* ── WORKSPACE ── */
.workspace-layout {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 14px;
  flex: 1;
  overflow: hidden;
  padding-bottom: 16px;
}

.workspace-panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
}

.workspace-breadcrumb {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0;
  font-size: 10px;
  color: var(--ink-3);
  margin-bottom: 10px;
  padding: 5px 8px;
  background: var(--bg);
  border: 1px solid var(--border-dim);
  font-family: 'Geist Mono', monospace;
}
.workspace-breadcrumb a {
  color: var(--accent);
  text-decoration: none;
  padding: 1px 3px;
}
.workspace-breadcrumb a:hover { background: var(--accent-ghost); }
.workspace-breadcrumb .sep { color: var(--border); padding: 0 1px; }

.file-browser {
  background: var(--bg);
  border: 1px solid var(--border-dim);
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border-dim);
  font-size: 11px;
  color: var(--ink-3);
  text-decoration: none;
  transition: background 0.1s;
}
.file-item:last-child { border-bottom: none; }
.file-item:hover { background: var(--accent-ghost); color: var(--ink); }
.file-item.is-dir { color: var(--accent); }
.file-item.is-parent { color: var(--ink-3); font-style: italic; }
.file-item.is-selected { background: var(--accent-ghost); color: var(--ink); border-left: 2px solid var(--accent); }
.file-sym { color: var(--border); font-size: 9px; font-weight: 600; }

.code-preview {
  flex: 1;
  overflow: auto;
  min-height: 0;
  font-size: 11px;
}

/* ── CHANNELS REDESIGN ── */
.channels-page {
  flex: 1;
  overflow: auto;
  padding-bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-width: 660px;
}

.integration-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--ch-color, var(--accent));
}

.integration-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-dim);
}

.integration-identity {
  display: flex;
  align-items: center;
  gap: 14px;
}

.integration-icon {
  width: 34px;
  height: 34px;
  border: 1px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.integration-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--ink);
}

.integration-desc {
  font-size: 10px;
  color: var(--ink-3);
  margin-top: 3px;
  letter-spacing: 0.3px;
}

.ch-badge {
  font-size: 9px;
  padding: 3px 9px;
  border: 1px solid;
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.ch-badge-on  { color: var(--accent);  border-color: var(--accent-dim); }
.ch-badge-off { color: var(--ink-3);   border-color: var(--border); }
.ch-badge-none{ color: var(--border);  border-color: var(--border-dim); }

.integration-body { padding: 20px; }

.form-row-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 18px;
  border-bottom: 1px dashed var(--border-dim);
  margin-bottom: 20px;
}

.form-section { margin-bottom: 18px; }

.form-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--ink);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-tag {
  font-size: 8px;
  padding: 1px 6px;
  letter-spacing: 1px;
  font-weight: 500;
  border: 1px solid;
}

.form-tag-req { color: var(--accent); border-color: var(--accent-dim); background: var(--accent-ghost); }
.form-tag-opt { color: var(--border); border-color: var(--border-dim); }

.form-hint {
  font-size: 10px;
  color: var(--ink-3);
  margin-bottom: 8px;
  line-height: 1.6;
}

.code-inline {
  font-family: 'Geist Mono', monospace;
  background: var(--sysbar);
  padding: 1px 5px;
  font-size: 10px;
  color: var(--accent);
  border: 1px solid var(--border-dim);
}

.ch-form-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--ink);
  font-family: 'Geist Mono', monospace;
  font-size: 12px;
  padding: 10px 12px;
  outline: none;
  transition: border-color 0.15s;
  box-sizing: border-box;
}

.ch-form-input:focus { border-color: var(--accent); }
.ch-form-input::placeholder { color: var(--border); }

.ch-form-textarea {
  min-height: 80px;
  resize: vertical;
}

.token-input-wrap { position: relative; }
.token-input-wrap .ch-form-input { padding-right: 44px; }

.token-toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--ink-3);
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  transition: color 0.15s;
}

.token-toggle-btn:hover { color: var(--ink); }

.form-actions {
  margin-top: 22px;
  padding-top: 16px;
  border-top: 1px dashed var(--border-dim);
  display: flex;
  justify-content: flex-end;
}

.btn-save {
  background: var(--accent);
  color: #fff;
  border: none;
  font-family: 'Geist Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  padding: 10px 28px;
  cursor: pointer;
  letter-spacing: 2px;
  text-transform: uppercase;
  transition: background 0.15s;
}

.btn-save:hover { background: var(--ink); }

/* CSS toggle switch */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 22px;
  flex-shrink: 0;
}

.toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }

.toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--border);
  transition: background 0.2s;
  border-radius: 2px;
}

.toggle-slider::before {
  content: '';
  position: absolute;
  height: 16px;
  width: 16px;
  left: 3px;
  top: 3px;
  background: var(--bg);
  transition: transform 0.2s;
}

.toggle-switch input:checked + .toggle-slider { background: var(--accent); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }

/* Coming soon channels */
.coming-soon-section { margin-top: 4px; }

.coming-soon-label {
  font-size: 9px;
  color: var(--border);
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-bottom: 12px;
}

.coming-soon-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.soon-card {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border: 1px dashed var(--border-dim);
  font-size: 10px;
  color: var(--border);
  letter-spacing: 0.5px;
  opacity: 0.5;
}

.soon-icon { display: flex; align-items: center; }
{% endblock %}

{% block head %}
<script>
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
  document.getElementById(tabId).classList.add('active');
  history.replaceState(null, '', '?tab=' + tabId);
}
document.addEventListener('DOMContentLoaded', function() {
  var params = new URLSearchParams(window.location.search);
  var tab = params.get('tab') || 'overview';
  if (document.getElementById(tab)) switchTab(tab);
});

function toggleTokenVis() {
  var inp = document.getElementById('bot-token-input');
  var icon = document.getElementById('token-eye-icon');
  if (inp.type === 'password') {
    inp.type = 'text';
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>';
  } else {
    inp.type = 'password';
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
  }
}
</script>
{% endblock %}

{% block content %}
<div class="agent-page">

  <!-- Topbar -->
  <div class="agent-topbar">
    <div class="agent-title">
      <a href="/agents" class="btn btn-sm btn-dim">← back</a>
      {% if agent.status == 'active' %}
        <h1>{{ agent.name }}</h1>
      {% elif agent.status == 'idle' %}
        <h1 style="color:var(--idle)">{{ agent.name }}</h1>
      {% else %}
        <h1 style="color:var(--border)">{{ agent.name }}</h1>
      {% endif %}
    </div>
    <div style="font-size:9px;color:var(--ink-3);letter-spacing:2px">uuid:{{ agent.id[:8] }}...</div>
  </div>

  <!-- Tab nav -->
  <div class="tabs-bar">
    <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">overview</button>
    <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">chat</button>
    <button class="tab-btn" data-tab="workspace" onclick="switchTab('workspace')">workspace</button>
    <button class="tab-btn" data-tab="channels" onclick="switchTab('channels')">channels</button>
    <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">settings</button>
  </div>

  <!-- ── OVERVIEW ── -->
  <div id="overview" class="tab-content active">
    <div class="card-grid card-grid-2" style="flex:1;overflow:auto;padding-bottom:16px;align-content:start">
      <div class="card">
        <div class="card-title">channels</div>
        <div class="ch-item">
          <span class="ch-name">web</span>
          <span class="ch-status-on" style="font-size:9px;letter-spacing:1px">default</span>
        </div>
        {% for ch in channels[:5] %}
        <div class="ch-item">
          <span class="ch-name">{{ ch.channel }}</span>
          {% if ch.enabled %}
            <span class="ch-status-on">● active</span>
          {% else %}
            <span class="ch-status-off">○ off</span>
          {% endif %}
        </div>
        {% endfor %}
        {% if not channels %}
        <a href="?tab=channels" onclick="switchTab('channels'); return false;"
           style="font-size:9px;color:var(--ink-3);text-decoration:none;display:block;margin-top:10px;letter-spacing:1px">
          configure integrations ›
        </a>
        {% elif channels | length > 5 %}
        <a href="?tab=channels" onclick="switchTab('channels'); return false;"
           style="font-size:9px;color:var(--ink-3);text-decoration:none;display:block;margin-top:10px;letter-spacing:2px">
          +{{ channels|length - 5 }} more ›
        </a>
        {% endif %}
      </div>

      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="card">
          <div class="card-title">stats</div>
          <div class="stat-row">
            <span class="label">Status</span>
            <span class="value">
              {% if agent.status == 'active' %}<span class="s-on">active</span>
              {% elif agent.status == 'idle' %}<span class="s-idle">idle</span>
              {% else %}<span class="s-off">offline</span>{% endif %}
            </span>
          </div>
          <div class="stat-row">
            <span class="label">Channels</span>
            <span class="value">{{ channels | length + 1 }}</span>
          </div>
          <div class="stat-row">
            <span class="label">Created</span>
            <span class="value">{{ agent.created_at }}</span>
          </div>
        </div>
        <div class="card">
          <div class="card-title">actions</div>
          <a href="?tab=chat" onclick="switchTab('chat'); return false;"
             class="btn" style="display:block;text-align:center;margin-bottom:8px">open chat</a>
          <a href="?tab=settings" onclick="switchTab('settings'); return false;"
             class="btn btn-dim" style="display:block;text-align:center">settings</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ── CHAT ── -->
  <div id="chat" class="tab-content">
    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <div id="chat-empty" class="chat-empty" style="{% if recent_messages %}display:none{% endif %}">
          <span>no messages yet</span>
          <span style="font-size:8px">type a message below</span>
        </div>
        {% if recent_messages %}
          {% for msg in recent_messages %}
          <div class="chat-bubble {{ msg.role }}" data-ts="{{ msg.timestamp }}">
            <div class="role-label">{{ msg.role }}</div>
            <div class="content">{{ msg.content }}</div>
            <div class="timestamp">{{ msg.timestamp }}</div>
          </div>
          {% endfor %}
        {% endif %}
      </div>
      <div class="chat-input-area">
        <div class="chat-input-row">
          <input type="text" id="chat-input" placeholder="message..." autocomplete="off" />
          <button type="button" class="chat-send-btn" id="chat-send-btn" title="Send">
            <svg id="chat-send-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
            <div class="spinner hidden" id="chat-spinner"></div>
          </button>
        </div>
        <div class="chat-status" id="chat-status"></div>
      </div>
    </div>
  </div>

  <!-- ── WORKSPACE ── -->
  <div id="workspace" class="tab-content">
    <div class="workspace-layout">

      <!-- File Browser -->
      <div class="card workspace-panel">
        <div class="card-title">files</div>

        <!-- Breadcrumb navigation -->
        <div class="workspace-breadcrumb">
          <a href="/agents/{{ agent.id }}?tab=workspace&path=.">~</a>
          {% if workspace_path != '.' %}
            {% set ns = namespace(crumb='') %}
            {% for part in workspace_path.split('/') %}
              {% if ns.crumb %}
                {% set ns.crumb = ns.crumb + '/' + part %}
              {% else %}
                {% set ns.crumb = part %}
              {% endif %}
              <span class="sep">/</span>
              <a href="/agents/{{ agent.id }}?tab=workspace&path={{ ns.crumb }}">{{ part }}</a>
            {% endfor %}
          {% endif %}
        </div>

        {% if workspace_error %}
          <div class="notice notice-err" style="padding:8px 12px;font-size:10px;margin-bottom:10px">{{ workspace_error }}</div>
        {% endif %}

        <div class="file-browser">
          {% if workspace_path != '.' %}
            <a href="/agents/{{ agent.id }}?tab=workspace&path={{ workspace_parent_path }}" class="file-item is-parent">
              <span class="file-sym">..</span>
              <span>parent directory</span>
            </a>
          {% endif %}
          {% if workspace_items %}
            {% for item in workspace_items %}
            <a href="{{ item.href }}" class="file-item {% if item.is_dir %}is-dir{% endif %} {% if not item.is_dir and selected_file and item.display == selected_file %}is-selected{% endif %}">
              <span class="file-sym">{% if item.is_dir %}[d]{% else %}[-]{% endif %}</span>
              <span>{{ item.display }}</span>
            </a>
            {% endfor %}
          {% else %}
            <div style="padding:20px;text-align:center;font-size:9px;color:var(--border);text-transform:uppercase;letter-spacing:3px">empty</div>
          {% endif %}
        </div>
      </div>

      <!-- File Preview -->
      <div class="card workspace-panel">
        {% if selected_file %}
          <div class="card-title" style="font-size:10px;word-break:break-all;margin-bottom:12px">{{ selected_file }}</div>
          {% if selected_file_error %}
            <div class="notice notice-err" style="padding:8px 12px;font-size:10px">{{ selected_file_error }}</div>
          {% else %}
            <div class="code-block code-preview">{{ selected_file_content }}</div>
          {% endif %}
        {% else %}
          <div class="card-title">file preview</div>
          <div style="display:flex;align-items:center;justify-content:center;flex:1;font-size:9px;color:var(--border);text-transform:uppercase;letter-spacing:3px">
            select a file
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- ── CHANNELS ── -->
  <div id="channels" class="tab-content">
    <div class="channels-page">

      <!-- Telegram -->
      <div class="integration-card" style="--ch-color:#2CA5E0">
        <div class="integration-header">
          <div class="integration-identity">
            <div class="integration-icon" style="background:rgba(44,165,224,0.08);border-color:rgba(44,165,224,0.25)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="#2CA5E0">
                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12l-6.871 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.941z"/>
              </svg>
            </div>
            <div>
              <div class="integration-name">Telegram</div>
              <div class="integration-desc">Connect a bot to this agent via Telegram</div>
            </div>
          </div>
          <div>
            {% if telegram and telegram.enabled %}
              <span class="ch-badge ch-badge-on">● active</span>
            {% elif telegram and telegram.bot_token %}
              <span class="ch-badge ch-badge-off">○ configured</span>
            {% else %}
              <span class="ch-badge ch-badge-none">— not set up</span>
            {% endif %}
          </div>
        </div>

        <div class="integration-body">
          <form method="post" action="/agents/{{ agent.id }}/telegram">

            <!-- Enable toggle -->
            <div class="form-row-toggle">
              <div>
                <div class="form-label">Enable bot</div>
                <div class="form-hint" style="margin-bottom:0">Receive and respond to messages via Telegram</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" name="enabled" {% if telegram and telegram.enabled %}checked{% endif %} />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- Bot token -->
            <div class="form-section">
              <div class="form-label">Bot Token <span class="form-tag form-tag-req">required</span></div>
              <div class="form-hint">Create a bot and get the token from <span class="code-inline">@BotFather</span> on Telegram</div>
              <div class="token-input-wrap">
                <input type="password" id="bot-token-input" name="bot_token"
                       value="{{ telegram_bot_token }}"
                       placeholder="123456789:AAFxxxxxxx..."
                       class="ch-form-input" autocomplete="off" />
                <button type="button" class="token-toggle-btn" onclick="toggleTokenVis()" title="Show / hide token">
                  <svg id="token-eye-icon" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Allowed chat IDs -->
            <div class="form-section">
              <div class="form-label">Allowed Chat IDs <span class="form-tag form-tag-opt">optional</span></div>
              <div class="form-hint">Restrict which chats can reach this agent. Leave empty to allow everyone.</div>
              <textarea name="allowed_chat_ids" class="ch-form-input ch-form-textarea"
                        placeholder="123456789&#10;-987654321&#10;...">{{ telegram_allowed_chat_ids }}</textarea>
              <div class="form-hint" style="margin-top:5px;margin-bottom:0">
                One ID per line · Use <span class="code-inline">@userinfobot</span> to find your chat ID
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-save">save</button>
            </div>

          </form>
        </div>
      </div>

      <!-- Coming soon -->
      <div class="coming-soon-section">
        <div class="coming-soon-label">more integrations coming soon</div>
        <div class="coming-soon-grid">
          <div class="soon-card">
            <span class="soon-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057c.002.022.015.043.032.056a19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994.021-.041.001-.09-.041-.106a13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
            </span>
            Discord
          </div>
          <div class="soon-card">
            <span class="soon-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
            </span>
            Slack
          </div>
          <div class="soon-card">
            <span class="soon-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
            </span>
            WhatsApp
          </div>
          <div class="soon-card">
            <span class="soon-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m2 7 10 7 10-7"/></svg>
            </span>
            Email
          </div>
          <div class="soon-card">
            <span class="soon-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </span>
            SMS
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ── SETTINGS ── -->
  <div id="settings" class="tab-content">
    <div class="card-grid card-grid-2" style="flex:1;overflow:auto;padding-bottom:16px;align-content:start">
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card">
          <div class="card-title">persona</div>
          <form method="post" action="/agents/{{ agent.id }}/persona">
            <div class="f">
              <textarea name="persona" style="min-height:140px;font-size:11px">{{ agent.persona }}</textarea>
            </div>
            <button type="submit" class="btn">save persona</button>
          </form>
        </div>

        <div class="card" style="border-color:#e0c0c0">
          <div class="card-title" style="color:#c0392b">danger zone</div>
          <p style="font-size:10px;color:var(--ink-3);margin-bottom:14px;letter-spacing:1px">
            Permanently delete this agent and all its data.
          </p>
          <form method="post" action="/agents/{{ agent.id }}/delete"
                onsubmit="return confirm('delete agent: {{ agent.name }}?\n\nthis cannot be undone.')">
            <button type="submit" class="btn-danger">delete agent</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-title">agent info</div>
        <div class="stat-row">
          <span class="label">ID</span>
          <span class="value" style="font-size:9px;word-break:break-all">{{ agent.id }}</span>
        </div>
        <div class="stat-row">
          <span class="label">Status</span>
          <span class="value">
            {% if agent.status == 'active' %}<span class="s-on">active</span>
            {% elif agent.status == 'idle' %}<span class="s-idle">idle</span>
            {% else %}<span class="s-off">offline</span>{% endif %}
          </span>
        </div>
        <div class="stat-row">
          <span class="label">Created</span>
          <span class="value">{{ agent.created_at }}</span>
        </div>
        <div class="stat-row">
          <span class="label">Updated</span>
          <span class="value">{{ agent.updated_at }}</span>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  var agentId = '{{ agent.id }}';
  var messagesEl = document.getElementById('chat-messages');
  var emptyEl = document.getElementById('chat-empty');
  var inputEl = document.getElementById('chat-input');
  var sendBtn = document.getElementById('chat-send-btn');
  var sendIcon = document.getElementById('chat-send-icon');
  var spinnerEl = document.getElementById('chat-spinner');
  var statusEl = document.getElementById('chat-status');
  var isLoading = false;
  var lastTimestamp = 0;

  function scrollToEnd() { messagesEl.scrollTop = messagesEl.scrollHeight; }

  function formatTime(ts) {
    if (typeof ts === 'number') {
      var d = new Date(ts * 1000);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    return ts;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function addMessage(msg) {
    emptyEl.style.display = 'none';
    var div = document.createElement('div');
    div.className = 'chat-bubble ' + msg.role;
    div.setAttribute('data-ts', msg.timestamp);
    div.innerHTML =
      '<div class="role-label">' + msg.role + '</div>' +
      '<div class="content">' + escapeHtml(msg.content) + '</div>' +
      '<div class="timestamp">' + formatTime(msg.timestamp) + '</div>';
    messagesEl.appendChild(div);
    if (msg.timestamp > lastTimestamp) lastTimestamp = msg.timestamp;
    scrollToEnd();
    return div;
  }

  function showTyping() {
    if (document.getElementById('typing-indicator')) return;
    emptyEl.style.display = 'none';
    var div = document.createElement('div');
    div.className = 'typing-indicator';
    div.id = 'typing-indicator';
    div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    messagesEl.appendChild(div);
    scrollToEnd();
  }

  function hideTyping() {
    var el = document.getElementById('typing-indicator');
    if (el) el.remove();
  }

  function setLoading(loading) {
    isLoading = loading;
    inputEl.disabled = loading;
    sendBtn.disabled = loading;
    sendIcon.classList.toggle('hidden', loading);
    spinnerEl.classList.toggle('hidden', !loading);
  }

  function setStatus(text, isError) {
    statusEl.textContent = text || '';
    statusEl.classList.toggle('error', !!isError);
  }

  async function sendMessage() {
    var content = inputEl.value.trim();
    if (!content || isLoading) return;
    inputEl.value = '';
    setLoading(true);
    setStatus('');
    addMessage({role:'user', content:content, timestamp:Math.floor(Date.now()/1000)});
    showTyping();
    try {
      var resp = await fetch('/api/agents/' + encodeURIComponent(agentId) + '/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: content})
      });
      if (!resp.ok) {
        var errData = await resp.json().catch(function(){return {};});
        throw new Error(errData.error || 'Request failed');
      }
      var data = await resp.json();
      hideTyping();
      if (data.messages) {
        messagesEl.querySelectorAll('.chat-bubble').forEach(function(el){ el.remove(); });
        lastTimestamp = 0;
        data.messages.forEach(function(m){ addMessage(m); });
      }
      setLoading(false);
    } catch(err) {
      hideTyping();
      setLoading(false);
      setStatus(err.message || 'failed to send message', true);
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  (function initTimestamps() {
    document.querySelectorAll('.chat-bubble').forEach(function(el) {
      var ts = parseInt(el.getAttribute('data-ts'), 10);
      if (ts > lastTimestamp) lastTimestamp = ts;
      var timeEl = el.querySelector('.timestamp');
      if (timeEl) timeEl.textContent = formatTime(ts);
    });
  })();
  scrollToEnd();
})();
</script>
{% endblock %}
